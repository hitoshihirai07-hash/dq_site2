<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ドラゴンクエストII データベース</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
           background-color:#111827;color:#e5e7eb;margin:0;padding:0; }
    header { background:#1f2937;padding:12px 16px;display:flex;align-items:center;
             justify-content:space-between;border-bottom:1px solid #374151; }
    header h1 { font-size:18px;margin:0; }
    header a { color:#93c5fd;text-decoration:none;font-size:14px; }
    main { padding:16px;max-width:1200px;margin:0 auto; }
    .tabs { display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap; }
    .tab-btn { border:1px solid #4b5563;background:#111827;color:#e5e7eb;
               padding:6px 10px;border-radius:999px;font-size:13px;cursor:pointer; }
    .tab-btn.active { background:#2563eb;border-color:#2563eb; }
    .controls { display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px;align-items:center; }
    .controls input[type="search"], .controls select {
      background:#111827;border:1px solid #4b5563;border-radius:6px;
      padding:6px 8px;color:#e5e7eb;font-size:13px;
    }
    .controls label { font-size:12px;color:#9ca3af;display:flex;flex-direction:column;gap:2px; }
    table { width:100%;border-collapse:collapse;font-size:12px; }
    thead { background:#111827;position:sticky;top:0;z-index:1; }
    th, td { border:1px solid #374151;padding:4px 6px;vertical-align:top; }
    th { text-align:left;white-space:nowrap; }
    tbody tr:nth-child(even) { background:#020617; }
    tbody tr:nth-child(odd) { background:#030712; }
    .pill { display:inline-block;padding:0 6px;border-radius:999px;font-size:11px;
            border:1px solid #4b5563;background:rgba(15,23,42,.8); }
    .muted { color:#9ca3af;font-size:11px;margin-top:4px; }
    .nowrap { white-space:nowrap; }
    .tab-panel { display:none; }
    .tab-panel.active { display:block; }
    .table-wrap { max-height:70vh;overflow:auto;border-radius:8px;border:1px solid #374151; }
  </style>
</head>
<body>
  <header>
    <h1>ドラゴンクエストII データベース</h1>
    <a href="index.html">← トップに戻る</a>
  </header>
  <main>
    <div class="tabs">
      <button class="tab-btn active" data-target="items">アイテム・装備</button>
      <button class="tab-btn" data-target="spells">呪文・特技</button>
      <button class="tab-btn" data-target="monsters">モンスター</button>
    </div>

    <section id="items" class="tab-panel active" aria-label="アイテム・装備">
      <div class="controls">
        <label>キーワード検索
          <input type="search" id="items-search" placeholder="名前・効果・入手方法など" />
        </label>
        <label>種別フィルタ
          <select id="items-kind">
            <option value="">すべて</option>
            <option value="道具">道具</option>
            <option value="装備">装備（全部）</option>
            <option value="装備盾">装備盾</option>
            <option value="装備兜">装備兜</option>
            <option value="装備服">装備服</option>
            <option value="装備装飾品">装備装飾品</option>
          </select>
        </label>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>種別</th>
              <th>名前</th>
              <th class="nowrap">攻撃力</th>
              <th class="nowrap">守備力</th>
              <th class="nowrap">買値</th>
              <th class="nowrap">売値</th>
              <th>効果</th>
              <th>入手方法</th>
              <th>装備可能</th>
              <th>備考</th>
            </tr>
          </thead>
          <tbody id="items-body"></tbody>
        </table>
      </div>
      <p class="muted">※ 装備可能・備考はCSVの列があれば表示されます。無ければ空欄になります。</p>
    </section>

    <section id="spells" class="tab-panel" aria-label="呪文・特技">
      <div class="controls">
        <label>キーワード検索
          <input type="search" id="spells-search" placeholder="名前・効果・必要技など" />
        </label>
        <label>種別フィルタ
          <select id="spells-kind">
            <option value="">すべて</option>
            <option value="呪文">呪文</option>
            <option value="特技">特技</option>
            <option value="超絶技">超絶技</option>
          </select>
        </label>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>種別</th>
              <th>名前</th>
              <th class="nowrap">消費MP</th>
              <th>効果</th>
              <th class="nowrap">習得Lv</th>
              <th>巻物</th>
              <th>備考</th>
            </tr>
          </thead>
          <tbody id="spells-body"></tbody>
        </table>
      </div>
    </section>

    <section id="monsters" class="tab-panel" aria-label="モンスター">
      <div class="controls">
        <label>キーワード検索
          <input type="search" id="monsters-search" placeholder="名前・出現エリア・ドロップなど" />
        </label>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>名前</th>
              <th>出現エリア</th>
              <th class="nowrap">HP</th>
              <th class="nowrap">経験値</th>
              <th class="nowrap">ゴールド</th>
              <th>ドロップ</th>
            </tr>
          </thead>
          <tbody id="monsters-body"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    const CSV_ITEMS = "data/dq2_items.csv";
    const CSV_SPELLS = "data/dq2_spells.csv";
    const CSV_MONSTERS = "data/dq2_monsters.csv";

    function parseCSV(text) {
      if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
      const rows = [];
      let row = [], field = "", inQuotes = false;
      for (let i = 0; i < text.length; i++) {
        const c = text[i];
        if (inQuotes) {
          if (c === '"') {
            if (text[i+1] === '"') { field += '"'; i++; }
            else { inQuotes = false; }
          } else field += c;
        } else {
          if (c === '"') inQuotes = true;
          else if (c === ",") { row.push(field); field = ""; }
          else if (c === "\n" || c === "\r") {
            if (c === "\r" && text[i+1] === "\n") i++;
            row.push(field);
            if (row.length > 1 || row[0] !== "") rows.push(row);
            row = []; field = "";
          } else field += c;
        }
      }
      if (field.length > 0 || row.length > 0) {
        row.push(field);
        rows.push(row);
      }
      return rows;
    }

    async function loadCSV(path) {
      const res = await fetch(path);
      const text = await res.text();
      const rows = parseCSV(text);
      if (!rows.length) return { header: [], data: [] };
      return { header: rows[0], data: rows.slice(1) };
    }

    function textMatch(haystack, needle) {
      if (!needle) return true;
      if (!haystack) return false;
      return haystack.toString().toLowerCase().includes(needle.toLowerCase());
    }
    function nl2br(text) {
      if (!text) return "";
      return text.replace(/\n/g, "<br>");
    }

    async function renderItems() {
      const { header, data } = await loadCSV(CSV_ITEMS);
      const idx = Object.fromEntries(header.map((h, i) => [h, i]));
      const tbody = document.getElementById("items-body");
      const searchInput = document.getElementById("items-search");
      const kindSelect = document.getElementById("items-kind");

      function applyFilter() {
        const kw = searchInput.value.trim();
        const kindFilter = kindSelect.value;
        tbody.innerHTML = "";

        const rowsToShow = [];

        for (const row of data) {
          const kind    = row[idx["種別"]] || "";
          const name    = row[idx["名前"]] || "";
          const atk     = idx["攻撃力"] !== undefined ? (row[idx["攻撃力"]] || "") : "";
          const def     = idx["守備力"] !== undefined ? (row[idx["守備力"]] || "") : "";
          const buyPrice  = idx["買値"] !== undefined ? (row[idx["買値"]] || "") : "";
          const sellPrice = idx["売値"] !== undefined ? (row[idx["売値"]] || "") : "";
          const effect  = idx["効果"]   !== undefined ? (row[idx["効果"]]   || "") : "";
          const acquire = idx["入手方法"] !== undefined ? (row[idx["入手方法"]] || "") : "";
          const equip   = idx["装備可能"] !== undefined ? (row[idx["装備可能"]] || "") : "";
          const note    = idx["備考"]     !== undefined ? (row[idx["備考"]]     || "") : "";

          // 種別フィルタ
          if (kindFilter) {
            if (kindFilter === "装備") {
              if (!kind.includes("装備")) continue;
            } else {
              if (kind !== kindFilter) continue;
            }
          }

          const fullText = [kind, name, atk, def, buyPrice, sellPrice, effect, acquire, equip, note].join(" ");
          if (!textMatch(fullText, kw)) continue;

          rowsToShow.push({ kind, name, atk, def, buyPrice, sellPrice, effect, acquire, equip, note });
        }

        rowsToShow.sort((a, b) => {
          const rank = (k) => {
            if (k === "道具") return 0;
            if (k.includes("装備")) return 1;
            return 2;
          };
          const ra = rank(a.kind);
          const rb = rank(b.kind);
          if (ra !== rb) return ra - rb;
          return (a.name || "").localeCompare(b.name || "", "ja");
        });

        for (const item of rowsToShow) {
          const tr = document.createElement("tr");

          const tdKind = document.createElement("td");
          if (item.kind) {
            const span = document.createElement("span");
            span.className = "pill";
            span.textContent = item.kind;
            tdKind.appendChild(span);
          }
          tr.appendChild(tdKind);

          const tdName = document.createElement("td");
          tdName.textContent = item.name;
          tr.appendChild(tdName);

          const tdAtk = document.createElement("td");
          tdAtk.className = "nowrap";
          tdAtk.textContent = item.atk;
          tr.appendChild(tdAtk);

          const tdDef = document.createElement("td");
          tdDef.className = "nowrap";
          tdDef.textContent = item.def;
          tr.appendChild(tdDef);

          const tdBuy = document.createElement("td");
          tdBuy.className = "nowrap";
          tdBuy.textContent = item.buyPrice;
          tr.appendChild(tdBuy);

          const tdSell = document.createElement("td");
          tdSell.className = "nowrap";
          tdSell.textContent = item.sellPrice;
          tr.appendChild(tdSell);

          const tdEffect = document.createElement("td");
          tdEffect.innerHTML = nl2br(item.effect);
          tr.appendChild(tdEffect);

          const tdAcquire = document.createElement("td");
          tdAcquire.innerHTML = nl2br(item.acquire);
          tr.appendChild(tdAcquire);

          const tdEquip = document.createElement("td");
          tdEquip.innerHTML = nl2br(item.equip);
          tr.appendChild(tdEquip);

          const tdNote = document.createElement("td");
          tdNote.innerHTML = nl2br(item.note);
          tr.appendChild(tdNote);

          tbody.appendChild(tr);
        }
      }

      searchInput.addEventListener("input", applyFilter);
      kindSelect.addEventListener("change", applyFilter);
      applyFilter();
    }

    async function renderSpells() {
      const { header, data } = await loadCSV(CSV_SPELLS);
      const idx = Object.fromEntries(header.map((h, i) => [h, i]));
      const tbody = document.getElementById("spells-body");
      const searchInput = document.getElementById("spells-search");
      const kindSelect = document.getElementById("spells-kind");

      function applyFilter() {
        const kw = searchInput.value.trim();
        const kindFilter = kindSelect.value;
        tbody.innerHTML = "";

        for (const row of data) {
          let kind   = row[idx["種別"]] || "";
          const name = row[idx["名前"]] || "";
          const mp   = idx["消費MP"] !== undefined ? (row[idx["消費MP"]] || "") : "";
          const effect = idx["効果"] !== undefined ? (row[idx["効果"]] || "") : "";
          const learnLv = idx["習得レベル"] !== undefined ? (row[idx["習得レベル"]] || "") : "";
          const scroll  = idx["巻物取得可能"] !== undefined ? (row[idx["巻物取得可能"]] || "") : "";
          const note    = idx["備考"] !== undefined ? (row[idx["備考"]] || "") : "";

          const kindForDisplay = kind || (note && note.includes("必要技") ? "超絶技" : kind);

          if (kindFilter && kindForDisplay !== kindFilter) continue;

          const fullText = [kindForDisplay, name, mp, effect, learnLv, scroll, note].join(" ");
          if (!textMatch(fullText, kw)) continue;

          const tr = document.createElement("tr");

          const tdKind = document.createElement("td");
          if (kindForDisplay) {
            const span = document.createElement("span");
            span.className = "pill";
            span.textContent = kindForDisplay;
            tdKind.appendChild(span);
          }
          tr.appendChild(tdKind);

          const tdName = document.createElement("td");
          tdName.textContent = name;
          tr.appendChild(tdName);

          const tdMp = document.createElement("td");
          tdMp.className = "nowrap";
          tdMp.textContent = mp;
          tr.appendChild(tdMp);

          const tdEffect = document.createElement("td");
          tdEffect.innerHTML = nl2br(effect);
          tr.appendChild(tdEffect);

          const tdLv = document.createElement("td");
          tdLv.className = "nowrap";
          tdLv.textContent = learnLv;
          tr.appendChild(tdLv);

          const tdScroll = document.createElement("td");
          tdScroll.textContent = scroll;
          tr.appendChild(tdScroll);

          const tdNote = document.createElement("td");
          tdNote.innerHTML = nl2br(note);
          tr.appendChild(tdNote);

          tbody.appendChild(tr);
        }
      }

      searchInput.addEventListener("input", applyFilter);
      kindSelect.addEventListener("change", applyFilter);
      applyFilter();
    }

    async function renderMonsters() {
      const { header, data } = await loadCSV(CSV_MONSTERS);
      const idx = Object.fromEntries(header.map((h, i) => [h, i]));
      const tbody = document.getElementById("monsters-body");
      const searchInput = document.getElementById("monsters-search");

      function applyFilter() {
        const kw = searchInput.value.trim();
        tbody.innerHTML = "";

        for (const row of data) {
          const name = row[idx["名前"]] || "";
          const area = row[idx["出現エリア"]] || "";
          const hp   = idx["HP"]       !== undefined ? (row[idx["HP"]]       || "") : "";
          const exp  = idx["経験値"]   !== undefined ? (row[idx["経験値"]]   || "") : "";
          const gold = idx["ゴールド"] !== undefined ? (row[idx["ゴールド"]] || "") : "";
          const drop = idx["ドロップ"] !== undefined ? (row[idx["ドロップ"]] || "") : "";

          const fullText = [name, area, hp, exp, gold, drop].join(" ");
          if (!textMatch(fullText, kw)) continue;

          const tr = document.createElement("tr");

          const tdName = document.createElement("td");
          tdName.textContent = name;
          tr.appendChild(tdName);

          const tdArea = document.createElement("td");
          tdArea.innerHTML = nl2br(area);
          tr.appendChild(tdArea);

          const tdHp = document.createElement("td");
          tdHp.className = "nowrap";
          tdHp.textContent = hp;
          tr.appendChild(tdHp);

          const tdExp = document.createElement("td");
          tdExp.className = "nowrap";
          tdExp.textContent = exp;
          tr.appendChild(tdExp);

          const tdGold = document.createElement("td");
          tdGold.className = "nowrap";
          tdGold.textContent = gold;
          tr.appendChild(tdGold);

          const tdDrop = document.createElement("td");
          tdDrop.innerHTML = nl2br(drop);
          tr.appendChild(tdDrop);

          tbody.appendChild(tr);
        }
      }

      searchInput.addEventListener("input", applyFilter);
      applyFilter();
    }

    function setupTabs() {
      const buttons = document.querySelectorAll(".tab-btn");
      const panels = document.querySelectorAll(".tab-panel");
      buttons.forEach(btn => {
        btn.addEventListener("click", () => {
          const target = btn.dataset.target;
          buttons.forEach(b => b.classList.remove("active"));
          panels.forEach(p => p.classList.remove("active"));
          btn.classList.add("active");
          document.getElementById(target).classList.add("active");
        });
      });
    }

    window.addEventListener("DOMContentLoaded", () => {
      setupTabs();
      renderItems();
      renderSpells();
      renderMonsters();
    });
  </script>
</body>
</html>
