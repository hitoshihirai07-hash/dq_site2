<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>DQI ボス詳細（HD-2D版）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- サイト全体のデザインに合わせるため、このページでは個別の色指定を行いません -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <p><a href="./index.html">← トップに戻る</a>　<a href="./dq1_boss_list.html">← DQI ボス一覧に戻る</a></p>

  <h1>DQI ボス詳細</h1>
  <p id="boss-title"></p>

  <h2>ステータス</h2>
  <table id="status-table" border="1" cellspacing="0" cellpadding="4">
    <thead>
      <tr>
        <th>個体名</th>
        <th>体数</th>
        <th>HP</th>
        <th>経験値</th>
        <th>ゴールド</th>
        <th>出現場所</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="6">読み込み中...</td></tr>
    </tbody>
  </table>

  <h2>行動パターン</h2>
  <table id="action-table" border="1" cellspacing="0" cellpadding="4">
    <thead>
      <tr>
        <th>個体名</th>
        <th>特徴メモ</th>
        <th>行動パターン</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="3">読み込み中...</td></tr>
    </tbody>
  </table>

  <h2>耐性まとめ</h2>
  <p>◎…特に有効 ／ ○…有効 ／ △…やや効きにくい ／ ×…ほとんど効かない</p>
  <table id="res-table" border="1" cellspacing="0" cellpadding="4">
    <thead></thead>
    <tbody>
      <tr><td>読み込み中...</td></tr>
    </tbody>
  </table>

  <script>
    const CSV_MULTI = "dq1_boss_multiunit.csv";
    const CSV_RESIST = "dq1_boss_resistance.csv";

    function getBossNameFromQuery() {
      const params = new URLSearchParams(window.location.search);
      return params.get("boss") || "";
    }

    function setBossTitle(name) {
      const el = document.getElementById("boss-title");
      if (!name) {
        el.textContent = "ボス戦名が指定されていません。";
      } else {
        el.textContent = "ボス戦名：" + name;
      }
    }

    async function loadCsv(path) {
      const res = await fetch(path);
      if (!res.ok) throw new Error("データの読み込みに失敗しました: " + path);
      const text = await res.text();
      const parsed = Papa.parse(text, {
        header: true,
        skipEmptyLines: true,
      });
      return parsed.data;
    }

    function fillStatusTable(rows) {
      const tbody = document.querySelector("#status-table tbody");
      tbody.innerHTML = "";
      if (!rows.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 6;
        td.textContent = "このボスのステータス情報は登録されていません。";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }
      rows.forEach(r => {
        const tr = document.createElement("tr");
        const cols = ["個体名", "体数", "HP", "経験値", "ゴールド", "出現場所"];
        cols.forEach(c => {
          const td = document.createElement("td");
          td.textContent = r[c] ?? "";
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    function fillActionTable(rows) {
      const tbody = document.querySelector("#action-table tbody");
      tbody.innerHTML = "";
      if (!rows.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 3;
        td.textContent = "このボスの行動パターン情報は登録されていません。";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }
      rows.forEach(r => {
        const tr = document.createElement("tr");
        const nameTd = document.createElement("td");
        nameTd.textContent = r["個体名"] ?? "";
        tr.appendChild(nameTd);

        const featureTd = document.createElement("td");
        featureTd.textContent = r["特徴メモ"] ?? "";
        tr.appendChild(featureTd);

        const actTd = document.createElement("td");
        actTd.textContent = r["行動パターン"] ?? "";
        tr.appendChild(actTd);

        tbody.appendChild(tr);
      });
    }

    function createResHeader(headers) {
      const thead = document.querySelector("#res-table thead");
      thead.innerHTML = "";
      const tr = document.createElement("tr");
      headers.forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        tr.appendChild(th);
      });
      thead.appendChild(tr);
    }

    function fillResTable(rows, headers) {
      const tbody = document.querySelector("#res-table tbody");
      tbody.innerHTML = "";
      if (!rows.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 99;
        td.textContent = "このボスの耐性データは登録されていません。";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }
      rows.forEach(r => {
        const tr = document.createElement("tr");
        headers.forEach(h => {
          const td = document.createElement("td");
          td.textContent = r[h] ?? "";
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    async function init() {
      const bossName = getBossNameFromQuery();
      setBossTitle(bossName);

      if (!bossName) {
        // boss指定が無い場合はテーブルだけエラー表示にして終了
        fillStatusTable([]);
        fillActionTable([]);
        fillResTable([], []);
        return;
      }

      try {
        // ステータス・行動パターン
        const multiRows = await loadCsv(CSV_MULTI);
        const targetMulti = multiRows.filter(r => (r["ボス戦名"] || "").trim() === bossName.trim());
        fillStatusTable(targetMulti);
        fillActionTable(targetMulti);

        // 耐性
        const resRows = await loadCsv(CSV_RESIST);
        let targetRes = resRows.filter(r => (r["ボス戦名"] || "").trim() === bossName.trim());
        if (!targetRes.length) {
          fillResTable([], []);
        } else {
          const allHeaders = Object.keys(targetRes[0]);
          const headers = allHeaders.filter(h => h !== "ボス戦名");
          createResHeader(headers);
          fillResTable(targetRes, headers);
        }
      } catch (e) {
        console.error(e);
        fillStatusTable([]);
        fillActionTable([]);
        fillResTable([], []);
      }
    }

    init();
  </script>
</body>
</html>
