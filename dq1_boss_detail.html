<!DOCTYPE html>
<html lang="ja">
<head>
  <link rel="stylesheet" href="theme.css">
  <meta charset="UTF-8">
  <title>DQI ボス詳細</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
  /* サブ（同行モンスター）用テーブルの見た目調整 */
  table.boss-sub-table {
    border-collapse: collapse;
    width: 100%;
    max-width: 900px;
    margin-top: 8px;
  }
  table.boss-sub-table th,
  table.boss-sub-table td {
    border: 1px solid #666; /* 線を濃くする */
    padding: 4px 6px;
    font-size: 12px;
  }
  table.boss-sub-table th {
    background: #f0f0f0;   /* ヘッダーだけ薄いグレー */
    text-align: center;
  }
  /* 数値っぽい列は右寄せにして見やすく */
  table.boss-sub-table td:nth-child(2),
  table.boss-sub-table td:nth-child(3),
  table.boss-sub-table td:nth-child(4),
  table.boss-sub-table td:nth-child(5) {
    text-align: right;
  }
</style>

</head>
<body>
  <h1>DQI ボス詳細</h1>

  <div data-role="boss-detail"
       data-csv="dq1_boss_multiunit.csv"></div>

  
<h2>ボス耐性</h2>
<p>◎…特に有効 ／ ○…有効 ／ △…やや効きにくい ／ ×…ほとんど効かない</p>
<table id="boss-resistance-table" class="boss-sub-table">
  <thead></thead>
  <tbody>
    <tr><td>読み込み中...</td></tr>
  </tbody>
</table>

<p><a href="dq1_boss_list.html">DQI ボス一覧に戻る</a></p>

  <script src="boss_pages.js"></script>
  <script>
    (function() {
      const CSV_PATH = "dq1_boss_resistance.csv";

      function getBossNameFromQuery() {
        const params = new URLSearchParams(window.location.search);
        return params.get("boss") || "";
      }

      function isEmptyValue(v) {
        if (v === null || v === undefined) return true;
        const s = String(v).trim();
        return s === "" || s.toLowerCase() === "nan";
      }

      function parseCsv(text) {
        const lines = text.replace(//g, "").split("
").filter(l => l.trim() !== "");
        if (!lines.length) return [];
        const headers = lines[0].split(",");
        const rows = [];
        for (let i = 1; i < lines.length; i++) {
          const cols = lines[i].split(",");
          const row = {};
          headers.forEach((h, idx) => {
            row[h] = cols[idx] !== undefined ? cols[idx] : "";
          });
          rows.push(row);
        }
        return rows;
      }

      async function loadResistance() {
        const bossName = getBossNameFromQuery();
        const table = document.getElementById("boss-resistance-table");
        if (!table) return;
        const thead = table.querySelector("thead");
        const tbody = table.querySelector("tbody");
        tbody.innerHTML = "";

        if (!bossName) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 99;
          td.textContent = "ボス戦名が指定されていません。";
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }

        try {
          const res = await fetch(CSV_PATH);
          if (!res.ok) throw new Error("読み込み失敗");
          const text = await res.text();
          const rows = parseCsv(text);

          const target = rows.filter(r => (r["ボス戦名"] || "").trim() === bossName.trim());
          if (!target.length) {
            const tr = document.createElement("tr");
            const td = document.createElement("td");
            td.colSpan = 99;
            td.textContent = "このボスの耐性データは登録されていません。";
            tr.appendChild(td);
            tbody.appendChild(tr);
            return;
          }

          const allCols = Object.keys(target[0]);
          const candidate = allCols.filter(c => c !== "ボス戦名");
          const visible = candidate.filter(col =>
            target.some(r => !isEmptyValue(r[col]))
          );

          const trHead = document.createElement("tr");
          visible.forEach(col => {
            const th = document.createElement("th");
            th.textContent = col;
            trHead.appendChild(th);
          });
          thead.innerHTML = "";
          thead.appendChild(trHead);

          target.forEach(r => {
            const tr = document.createElement("tr");
            visible.forEach(col => {
              const td = document.createElement("td");
              const v = r[col];
              td.textContent = isEmptyValue(v) ? "" : v;
              tr.appendChild(td);
            });
            tbody.appendChild(tr);
          });
        } catch (e) {
          console.error(e);
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 99;
          td.textContent = "耐性データの読み込みに失敗しました。";
          tr.appendChild(td);
          tbody.appendChild(tr);
        }
      }

      document.addEventListener("DOMContentLoaded", loadResistance);
    })();
  </script>
</body>
</html>
