<!DOCTYPE html>
<html lang="ja">
<head>
  <link rel="stylesheet" href="theme.css">
  <meta charset="UTF-8">
  <title>DQI ボス詳細</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
  /* サブ（同行モンスター）用テーブルの見た目調整 */
  table.boss-sub-table {
    border-collapse: collapse;
    width: 100%;
    max-width: 900px;
    margin-top: 8px;
  }
  table.boss-sub-table th,
  table.boss-sub-table td {
    border: 1px solid #ccc;
    padding: 4px 6px;
    font-size: 0.9rem;
  }
  table.boss-sub-table th {
    text-align: center;
  }
  table.boss-sub-table td {
    text-align: left;
  }

  /* 追加ステータス用 */
  section.boss-extra-status {
    margin-top: 16px;
  }
  section.boss-extra-status h2 {
    margin-bottom: 4px;
    font-size: 1.1rem;
  }
  table.boss-stat-table {
    border-collapse: collapse;
    width: 100%;
    max-width: 900px;
    margin-top: 4px;
  }
  table.boss-stat-table th,
  table.boss-stat-table td {
    border: 1px solid #ccc;
    padding: 4px 6px;
    font-size: 0.9rem;
  }
  table.boss-stat-table th {
    text-align: center;
  }
  table.boss-stat-table td {
    text-align: right;
  }
  table.boss-stat-table td:first-child {
    text-align: left;
  }
  p.boss-reward {
    margin-top: 4px;
    font-size: 0.9rem;
  }
  </style>
</head>
<body>
  <h1>DQI ボス詳細</h1>

  <div data-role="boss-detail"
       data-csv="dq1_boss_multiunit.csv"></div>

  <p><a href="dq1_boss_list.html">DQI ボス一覧に戻る</a></p>

  <script src="boss_pages.js"></script>
  <script>
  (function () {
    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name) || "";
    }

    function parseCsv(text) {
      const lines = text.replace(/\r\n/g, "\n").replace(/\r/g, "\n").split("\n");
      if (!lines.length) return [];
      const header = lines[0].split(",");
      const rows = [];
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        if (!line || !line.trim()) continue;
        const cols = line.split(",");
        const obj = {};
        for (let j = 0; j < header.length; j++) {
          const key = header[j] || ("col" + j);
          obj[key] = cols[j] !== undefined ? cols[j] : "";
        }
        rows.push(obj);
      }
      return rows;
    }

    function buildExtraStatus() {
      const container = document.querySelector("[data-role='boss-detail']");
      if (!container) return;
      const bossName = getQueryParam("boss");
      if (!bossName) return;

      const csvPath = container.getAttribute("data-csv");
      if (!csvPath) return;

      fetch(csvPath)
        .then(function (res) { return res.text(); })
        .then(function (text) {
          const rows = parseCsv(text);
          const target = rows.filter(function (r) {
            return (r["ボス戦名"] || "").trim() === bossName.trim();
          });
          if (!target.length) return;

          // キー判定（MP/攻撃/防御/素早さは存在する場合のみ使う）
          const sample = target[0];
          const mpKey = sample.hasOwnProperty("MP") ? "MP"
                       : sample.hasOwnProperty("ＭＰ") ? "ＭＰ" : null;
          const atkKey = sample.hasOwnProperty("攻撃") ? "攻撃"
                        : sample.hasOwnProperty("攻撃力") ? "攻撃力" : null;
          const defKey = sample.hasOwnProperty("防御") ? "防御"
                        : sample.hasOwnProperty("守備") ? "守備"
                        : sample.hasOwnProperty("守備力") ? "守備力" : null;
          const agiKey = sample.hasOwnProperty("素早さ") ? "素早さ"
                        : sample.hasOwnProperty("すばやさ") ? "すばやさ" : null;

          // すべて存在しないなら何も出さない
          if (!mpKey && !atkKey && !defKey && !agiKey) {
            return;
          }

          const section = document.createElement("section");
          section.className = "boss-extra-status";

          const h2 = document.createElement("h2");
          h2.textContent = "ステータス（補足）";
          section.appendChild(h2);

          const table = document.createElement("table");
          table.className = "boss-stat-table";

          const thead = document.createElement("thead");
          const trHead = document.createElement("tr");
          ["個体名", "体数", "HP", "MP", "攻撃", "防御", "素早さ"].forEach(function (label) {
            const th = document.createElement("th");
            th.textContent = label;
            trHead.appendChild(th);
          });
          thead.appendChild(trHead);
          table.appendChild(thead);

          const tbody = document.createElement("tbody");

          target.forEach(function (r) {
            const tr = document.createElement("tr");
            function addCell(value) {
              const td = document.createElement("td");
              td.textContent = value || "";
              tr.appendChild(td);
            }
            addCell(r["個体名"] || "");
            addCell(r["体数"] || "");
            addCell(r["HP"] || "");
            addCell(mpKey ? (r[mpKey] || "") : "");
            addCell(atkKey ? (r[atkKey] || "") : "");
            addCell(defKey ? (r[defKey] || "") : "");
            addCell(agiKey ? (r[agiKey] || "") : "");
            tbody.appendChild(tr);
          });

          table.appendChild(tbody);
          section.appendChild(table);

          // 経験値・ゴールドの補足（1行目のみ採用）
          var rewardParts = [];
          if (sample["経験値"]) rewardParts.push("経験値 " + sample["経験値"]);
          if (sample["ゴールド"]) rewardParts.push("ゴールド " + sample["ゴールド"]);
          if (rewardParts.length) {
            const p = document.createElement("p");
            p.className = "boss-reward";
            p.textContent = "撃破時の報酬：" + rewardParts.join(" / ");
            section.appendChild(p);
          }

          container.appendChild(section);
        })
        .catch(function (e) {
          console.error(e);
        });
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", buildExtraStatus);
    } else {
      buildExtraStatus();
    }
  })();
  </script>
</body>
</html>
