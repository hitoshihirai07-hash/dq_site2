<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DQI・Ⅱダメージ計算</title>
  <link rel="stylesheet" href="theme.css" />
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 16px; }
    .card { border: 1px solid rgba(255,255,255,.12); border-radius: 12px; padding: 14px; margin: 12px 0; background: rgba(0,0,0,.12); }
    .row { display: grid; grid-template-columns: repeat(12, 1fr); gap: 10px; }
    .col-12{grid-column: span 12;}
    .col-6{grid-column: span 6;}
    .col-4{grid-column: span 4;}
    .col-3{grid-column: span 3;}
    .col-2{grid-column: span 2;}
    label { display:block; font-size: 13px; opacity:.9; margin-bottom:6px; }
    input, select, button { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,.18); background: rgba(0,0,0,.2); color: inherit; }
    input[type="checkbox"]{ width:auto; }
    button { cursor: pointer; }
    .muted { opacity: .75; font-size: 13px; }
    .pill { display:inline-block; padding: 4px 10px; border: 1px solid rgba(255,255,255,.18); border-radius: 999px; font-size: 12px; opacity:.9; }
    .out { font-size: 20px; font-weight: 700; }
    .out small{ font-size: 13px; font-weight: 500; opacity:.8; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid rgba(255,255,255,.12); padding: 8px; font-size: 13px; text-align:left; vertical-align: top; }
    .btn-row{ display:flex; gap:6px; margin-top:6px; }
    .btn-mini{ width:auto; padding:6px 10px; border-radius:999px; font-size:12px; }
    .actions { display:flex; gap: 8px; flex-wrap: wrap; }
    .actions button { width: auto; }
    .right { text-align:right; }
  </style>
</head>
<body>
  <main class="wrap page-main">
    <h1>DQI・Ⅱダメージ計算</h1>
<section class="card">
      <h2 style="margin:0 0 10px 0;font-size:16px;">入力</h2>

      <div class="row">
        <div class="col-3">
          <label>作品</label>
          <select id="game">
            <option value="DQ1">DQ1</option>
            <option value="DQ2">DQ2</option>
          </select>
        </div>

        <div class="col-3">
          <label>ゲームモード</label>
          <select id="mode">
            <option value="バッチリぼうけん">バッチリぼうけん</option>
            <option value="楽ちんプレイ">楽ちんプレイ</option>
          </select>
          

        </div>

        <div class="col-3">
          <label>敵（任意）</label>
          <select id="enemy">
            <option value="">（未選択）</option>
          </select>
          

        </div>

        <div class="col-3">
          <label>敵の防御</label>
          <input id="def" type="number" inputmode="numeric" placeholder="例：499" />
        </div>

        <div class="col-3">
          <label>キャラ（任意）</label>
          <select id="chara">
            <option value="">（未選択）</option>
            <option value="DQ1主人公">DQ1主人公</option>
            <option value="DQ2ローレシア王子">DQ2ローレシア王子</option>
            <option value="DQ2サマルトリア王子">DQ2サマルトリア王子</option>
            <option value="DQ2ムーンブルク王女">DQ2ムーンブルク王女</option>
            <option value="DQ2サマルトリア王女">DQ2サマルトリア王女</option>
          </select>
          

        </div>

        <div class="col-2">
          <label>LV</label>
          <input id="lv" type="number" inputmode="numeric" placeholder="例：40" />
        </div>

        <div class="col-2">
          <label>運の良さ</label>
          <input id="luck" type="number" inputmode="numeric" placeholder="例：55" />
        </div>

        <div class="col-2">
          <label>運基準</label>
          <select id="luckBand">
            <option value="auto">自動</option>
            <option value="最小">最小</option>
            <option value="中">中</option>
            <option value="最大">最大</option>
          </select>
          <div id="luckBaseInfo" style="font-size:12px;opacity:.85;margin-top:6px;line-height:1.3;"></div>
          

        </div>

        <div class="col-3">
          <label>攻撃</label>
          <input id="atk" type="number" inputmode="numeric" placeholder="例：384" />
        </div>

        <div class="col-3">
          <label>技（任意）</label>
          <select id="skill">
            <option value="" data-mult="1">通常攻撃（倍率1.0）</option>
          </select>
          

        </div>

        <div class="col-2">
          <label>技倍率</label>
          
          <input id="skillMult" type="number" step="0.001" inputmode="decimal" placeholder="例：1.6" value="1" />
          <div class="btn-row">
            <button type="button" class="btn-mini" id="setSkillNormal">通常(1.1)</button>
            <button type="button" class="btn-mini" id="setSkillEffective">特効(1.6)</button>
          </div>

        </div>

        <div class="col-2">
          <label>バイキルト</label>
          <label style="display:flex;align-items:center;gap:8px;margin:0;padding:10px;border:1px solid rgba(255,255,255,.18);border-radius:10px;background:rgba(0,0,0,.2);">
            <input id="bikilt" type="checkbox" />
            有効（2倍）
          </label>
        </div>

        <div class="col-4">
          <label>ちからため / 超ちからため / おうえん</label>
          <select id="tame">
            <option value="none">なし</option>
            <option value="tame">ちからため（2倍）</option>
            <option value="super_tame">超ちからため（3倍）</option>
            <option value="ouen">おうえん（2倍）</option>
          </select>
          

        </div>

        <div class="col-2">
          <label>手動倍率（任意）</label>
          <input id="manualMult" type="number" step="0.001" inputmode="decimal" placeholder="例：1.2" value="1" />
        </div>

        <div class="col-4">
          <label>ルカニ/スカラ段階（-6〜+6）</label>
          <select id="defStage"></select>
          

        </div>

        <div class="col-2" style="display:flex;align-items:end;gap:10px;">
          <label style="margin:0;">
            <input id="stageUnknown" type="checkbox" />
            段階不明（1/3/6表示）
          </label>
        </div>
      </div>

      <div class="actions" style="margin-top:12px;">
        <button id="btnCalc">計算してログに追加</button>
        <button id="btnClear" type="button">ログ全消し</button>
        <button id="btnCsv" type="button">ログをCSVでDL</button>
      </div>
    </section>

    <section class="card">
      <h2 style="margin:0 0 10px 0;font-size:16px;">結果</h2>

      <div id="resultMain" class="out">-</div>
      <div class="muted" id="resultSub">-</div>

      <div id="resultBands" style="margin-top:10px;"></div>
    </section>

    <section class="card">
      <h2 style="margin:0 0 10px 0;font-size:16px;">ログ一覧</h2>
      

      <div style="overflow:auto;margin-top:10px;">
        <table id="logTable">
          <thead>
            <tr>
              <th>#</th>
              <th>作品</th>
              <th>敵</th>
              <th class="right">攻撃</th>
              <th class="right">防御</th>
              <th>運基準</th>
              <th>モード</th>
              <th>技</th>
              <th class="right">倍率</th>
              <th class="right">平均</th>
              <th class="right">最小〜最大</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
</main>

<script>
(() => {
  "use strict";

  const $ = (id) => document.getElementById(id);

  // ====== 固定データ（公開ページでは表示しない） ======
  const COEF = {
    DQ1: { a: 0.749991892417, b: 0.264610864087, c: 0.000498335818083 }, // a*A - b*D - c*A^2
    DQ2: { a: 0.971654263608598, b: 0.387760162755906, c: 0.00113383813266851, d: 0.000557355812240368 }, // a*A - b*D - c*A*D + d*D^2
  };

  const LUCK_MULT = {
    DQ1: { "最小": 0.753404, "中": 0.856676, "最大": 1.0 },
    DQ2: { "最小": 0.660913083635202, "中": 0.83753922756278, "最大": 1.0 },
  };

  const MODE_MULT = {
    "バッチリぼうけん": 1.0,
    "楽ちんプレイ": 1.2,
  };

  // 乱数レンジ（参考表示用）
  const RAND_MIN = 0.90;
  const RAND_MAX = 1.10;

  // 防御段階倍率（防御ダウンは +倍率 / 防御アップは 1/倍率）
  // 既知点：1,3,6（あなたのログ基準）。間は線形補間。
  const DEF_DOWN_POINTS = [
    { s: 0, m: 1.0 },
    { s: 1, m: 1.270721206 },     // ワイルドホッグ
    { s: 3, m: 1.433799785 },     // ワイルドホッグ
    { s: 6, m: 1.804518211 },     // シドー
  ];

  function clampInt(n, lo, hi){
    n = Math.trunc(n);
    return Math.max(lo, Math.min(hi, n));
  }

  function safeNumber(v, fallback=null){
    if (v === null || v === undefined) return fallback;
    if (typeof v === "string" && v.trim() === "") return fallback; // 空欄は0扱いにしない
    const n = Number(v);
    return Number.isFinite(n) ? n : fallback;
  }

  function floor0(x){
    return Math.floor(x);
  }

  function fmt(x, d=3){
    if (!Number.isFinite(x)) return "";
    return Number(x).toFixed(d).replace(/\.?0+$/,"");
  }

  function lerp(a,b,t){ return a + (b-a)*t; }

  function stageMult(stage){
    stage = clampInt(stage, -6, 6);
    if (stage === 0) return 1.0;

    const down = Math.abs(stage);
    // find segment
    let left = DEF_DOWN_POINTS[0], right = DEF_DOWN_POINTS[DEF_DOWN_POINTS.length-1];
    for (let i=0;i<DEF_DOWN_POINTS.length-1;i++){
      const p = DEF_DOWN_POINTS[i], q = DEF_DOWN_POINTS[i+1];
      if (down >= p.s && down <= q.s){ left = p; right = q; break; }
    }
    let m;
    if (right.s === left.s) m = left.m;
    else m = lerp(left.m, right.m, (down - left.s) / (right.s - left.s));

    // stage < 0 => 防御ダウン（ダメ増）
    // stage > 0 => 防御アップ（ダメ減）= 逆数
    return stage < 0 ? m : (1.0 / m);
  }

  function baseDamage(game, A, D){
    if (game === "DQ1"){
      const {a,b,c} = COEF.DQ1;
      return a*A - b*D - c*(A*A);
    }
    const {a,b,c,d} = COEF.DQ2;
    return a*A - b*D - c*(A*D) + d*(D*D);
  }

  // ====== 外部データ（同一サイト内ページから読み取り） ======
  const SRC = {
    bossList: { DQ1: "dq1_boss_list.html", DQ2: "dq2_boss_list.html" },
    db: { DQ1: "dq1_db.html", DQ2: "dq2_db.html" },
    characterIndex: "dq_character.html",
  };

  let enemyMap = { DQ1: [], DQ2: [] }; // {name, def}
  let skillMap = { DQ1: [], DQ2: [] }; // {name, mult, multEff}
  let charPages = new Map(); // name -> href
  let lastLuckInfo = null; // {low, high, luck, band}

  function withIframe(url, tryExtract, timeoutMs=12000, intervalMs=120){
    return new Promise((resolve) => {
      const iframe = document.createElement("iframe");
      iframe.style.display = "none";
      iframe.src = url;
      document.body.appendChild(iframe);

      const start = Date.now();
      let done = false;

      const cleanup = () => { try { iframe.remove(); } catch(e){} };

      const tick = () => {
        if (done) return;
        let doc = null;
        try { doc = iframe.contentDocument; } catch(e){ doc = null; }
        let val = null;
        try { val = doc ? tryExtract(doc) : null; } catch(e){ val = null; }

        if (val){
          done = true; cleanup(); resolve(val); return;
        }
        if (Date.now() - start > timeoutMs){
          done = true; cleanup(); resolve(null); return;
        }
        setTimeout(tick, intervalMs);
      };

      iframe.addEventListener("load", () => setTimeout(tick, intervalMs));
      iframe.addEventListener("error", () => { done = true; cleanup(); resolve(null); });
    });
  }

  function rowsOf(t){
    const tbody = t.querySelector("tbody");
    if (tbody) return Array.from(tbody.querySelectorAll("tr"));
    return Array.from(t.querySelectorAll("tr")).slice(1);
  }
  function headersOf(t){
    const tr = t.querySelector("thead tr") || t.querySelector("tr");
    if (!tr) return [];
    return Array.from(tr.children).map(c => (c.textContent||"").trim());
  }
  function parseNums(text){
    const s = String(text||"").replace(/,/g," ");
    const ms = s.match(/-?\d+(?:\.\d+)?/g) || [];
    return ms.map(Number).filter(n => Number.isFinite(n));
  }

  function extractBossOrder(doc){
    // ボス一覧：最初の「名前」っぽい列があるテーブルを優先、無ければリンク順
    const tables = Array.from(doc.querySelectorAll("table"));
    for (const t of tables){
      const h = headersOf(t);
      if (!h.length) continue;
      const idxName = h.findIndex(x => x.includes("ボス") || x.includes("敵") || x.includes("名前") || x.includes("名称"));
      if (idxName < 0) continue;
      const out = [];
      for (const tr of rowsOf(t)){
        const cells = Array.from(tr.children);
        const name = (cells[idxName]?.textContent || "").trim();
        if (!name) continue;
        out.push({ name });
      }
      if (out.length) return out;
    }
    // fallback: link order
    const out = [];
    for (const a of Array.from(doc.querySelectorAll("a"))){
      const name = (a.textContent||"").trim();
      if (!name) continue;
      out.push({ name });
    }
    return out.length ? out : null;
  }

  function extractBossDefenseMap(doc){
    // DB側：防御がある表（名前＋防御）
    const tables = Array.from(doc.querySelectorAll("table"));
    for (const t of tables){
      const h = headersOf(t);
      if (!h.length) continue;
      const idxName = h.findIndex(x => x.includes("ボス") || x.includes("敵") || x.includes("名前") || x.includes("名称"));
      const idxDef = h.findIndex(x => x.includes("守備") || x.includes("防御"));
      if (idxName < 0 || idxDef < 0) continue;

      const map = {};
      for (const tr of rowsOf(t)){
        const cells = Array.from(tr.children);
        const name = (cells[idxName]?.textContent || "").trim();
        if (!name) continue;
        const nums = parseNums(cells[idxDef]?.textContent || "");
        if (!nums.length) continue;
        map[name] = nums[0];
      }
      if (Object.keys(map).length) return map;
    }
    return null;
  }

  function extractSkillList(doc){
    // 「倍率」列がある表
    const tables = Array.from(doc.querySelectorAll("table"));
    for (const t of tables){
      const h = headersOf(t);
      if (!h.length) continue;
      const idxName = h.findIndex(x => x.includes("名前") || x.includes("名称") || x.includes("技"));
      const idxMult = h.findIndex(x => x.includes("倍率"));
      if (idxName < 0 || idxMult < 0) continue;

      const out = [];
      for (const tr of rowsOf(t)){
        const cells = Array.from(tr.children);
        const name = (cells[idxName]?.textContent || "").trim();
        if (!name) continue;
        const nums = parseNums(cells[idxMult]?.textContent || "");
        if (!nums.length) continue;
        const normal = nums[0];
        const eff = nums.length >= 2 ? nums[1] : null;
        out.push({ name, mult: normal, multEff: eff });
      }
      if (out.length) return out;
    }
    return null;
  }

  function extractCharacterLinks(doc){
    // dq_character.html からキャラページのリンクを拾う
    const out = [];
    for (const a of Array.from(doc.querySelectorAll("a"))){
      const href = (a.getAttribute("href") || "").trim();
      if (!href || !href.endsWith(".html")) continue;
      // characterページっぽい
      if (!/dq_character_/i.test(href)) continue;
      const name = (a.textContent || "").trim();
      if (!name) continue;
      out.push({ name, href });
    }
    return out.length ? out : null;
  }

  function extractLuckInfoFromCharacter(doc, lv){
    // 1) 運の良さ（ステータス表）
    // 2) 運下限/運上限（運基準表）
    const tables = Array.from(doc.querySelectorAll("table"));
    let luck = null, low = null, high = null;

    for (const t of tables){
      const h = headersOf(t);
      if (!h.length) continue;

      const idxLv = h.findIndex(x => x === "LV" || x.includes("LV") || x.includes("レベル"));
      if (idxLv < 0) continue;

      const idxLuck = h.findIndex(x => x.includes("運の良さ") || (x.includes("運") && !x.includes("運下限") && !x.includes("運上限") && !x.includes("運基準")));
      const idxLow = h.findIndex(x => x.includes("運下限"));
      const idxHigh = h.findIndex(x => x.includes("運上限"));

      for (const tr of rowsOf(t)){
        const cells = Array.from(tr.children);
        const lvCell = safeNumber((cells[idxLv]?.textContent || "").trim(), null);
        if (lvCell === null) continue;
        if (Math.trunc(lvCell) !== Math.trunc(lv)) continue;

        if (idxLuck >= 0 && luck === null){
          const n = safeNumber((cells[idxLuck]?.textContent || "").trim(), null);
          if (n !== null) luck = n;
        }
        if (idxLow >= 0 && low === null){
          const n = safeNumber((cells[idxLow]?.textContent || "").trim(), null);
          if (n !== null) low = n;
        }
        if (idxHigh >= 0 && high === null){
          const n = safeNumber((cells[idxHigh]?.textContent || "").trim(), null);
          if (n !== null) high = n;
        }
      }
    }

    if (low === null || high === null){
      // まれに「運基準」表が別形式：列に「運基準」「運下限」「運上限」だけでLV無し
      // この場合は拾えないので null のまま返す
    }

    if (luck === null && low === null && high === null) return null;
    return { luck, low, high };
  }

  async function loadEnemies(game){
    const defMap = await withIframe(SRC.db[game], (doc) => extractBossDefenseMap(doc)) || {};
    const order = await withIframe(SRC.bossList[game], (doc) => extractBossOrder(doc)) || [];
    const seen = new Set();
    const out = [];
    for (const it of order){
      const name = String(it.name || "").trim();
      if (!name || seen.has(name)) continue;
      seen.add(name);
      const def = Number.isFinite(it.def) ? it.def : (Number.isFinite(defMap[name]) ? defMap[name] : null);
      out.push({ name, def });
    }
    enemyMap[game] = out;
  }

  async function loadSkills(game){
    const list = await withIframe(SRC.db[game], (doc) => extractSkillList(doc)) || [];
    // 先頭に通常攻撃
    skillMap[game] = [{ name:"通常攻撃", mult:1.0, multEff:null }, ...list];
  }

  async function loadCharacterIndex(){
    const list = await withIframe(SRC.characterIndex, (doc) => extractCharacterLinks(doc)) || [];
    // name->href
    charPages.clear();
    list.forEach(it => charPages.set(it.name, it.href));
  }

  function clearOptions(sel, keepEmpty){
    const keep = keepEmpty ? 1 : 0;
    while (sel.options.length > keep) sel.remove(keep);
  }

  function refreshEnemySelect(){
    const game = $("game").value;
    const sel = $("enemy");
    clearOptions(sel, true);
    (enemyMap[game] || []).forEach(it => {
      const op = document.createElement("option");
      op.value = it.name;
      op.textContent = it.name;
      if (Number.isFinite(it.def)) op.dataset.def = String(it.def);
      sel.appendChild(op);
    });
  }

  function refreshSkillSelect(){
    const game = $("game").value;
    const sel = $("skill");
    clearOptions(sel, true);
    (skillMap[game] || []).forEach(it => {
      const op = document.createElement("option");
      op.value = it.name;
      const hasEff = Number.isFinite(it.multEff) && it.multEff !== null && Math.abs(it.multEff - it.mult) > 1e-9;
      op.textContent = hasEff ? `${it.name}（通常${fmt(it.mult,3)} / 特効${fmt(it.multEff,3)}）`
                              : `${it.name}（倍率${fmt(it.mult,3)}）`;
      op.dataset.mult = String(it.mult);
      op.dataset.multEff = hasEff ? String(it.multEff) : "";
      sel.appendChild(op);
    });
    // 未選択なら倍率1
    if (!sel.value) $("skillMult").value = "1";
    updateSkillButtons();
  }

  function updateSkillButtons(){
    const sel = $("skill");
    const op = sel.options[sel.selectedIndex];
    const normal = safeNumber(op?.dataset?.mult, 1.0) ?? 1.0;
    const effRaw = op?.dataset?.multEff;
    const eff = safeNumber(effRaw, null);
    const btnN = $("setSkillNormal");
    const btnE = $("setSkillEffective");
    btnN.textContent = `通常(${fmt(normal,3)})`;
    if (eff !== null){
      btnE.disabled = false;
      btnE.textContent = `特効(${fmt(eff,3)})`;
    }else{
      btnE.disabled = true;
      btnE.textContent = `特効`;
    }
  }

  // ====== 運基準：自動判定 & 数値表示 ======
  function decideLuckBand(game, luck, low, high){
    if (!Number.isFinite(luck) || !Number.isFinite(low) || !Number.isFinite(high)) return null;
    // 下限 >> 運 => 最小 / 下限<=運<=上限 => 中 / 上限<運 => 最大
    if (luck < low) return "最小";
    if (luck <= high) return "中";
    return "最大";
  }

  function renderLuckBaseInfo(){
    const el = $("luckBaseInfo");
    if (!el) return;
    const lv = safeNumber($("lv").value, null);
    const luck = safeNumber($("luck").value, null);

    if (!lastLuckInfo || lv === null){
      el.textContent = "";
      return;
    }

    const low = lastLuckInfo.low;
    const high = lastLuckInfo.high;

    // 3種類：下限 / 上限 / 現在
    const parts = [];
    if (Number.isFinite(low)) parts.push(`下限 ${Math.trunc(low)}`);
    if (Number.isFinite(high)) parts.push(`上限 ${Math.trunc(high)}`);
    if (Number.isFinite(luck)) parts.push(`運 ${Math.trunc(luck)}`);
    el.textContent = parts.join(" / ");
  }

  async function updateLuckAuto(){
    const bandSel = $("luckBand").value;
    const chara = $("chara").value;
    const lv = safeNumber($("lv").value, null);

    lastLuckInfo = null;

    if (!chara || lv === null){
      renderLuckBaseInfo();
      return;
    }

    // キャラページが分からない場合は何もしない
    let href = charPages.get(chara) || null;
    if (!href){
      // 部分一致（select値にDQ1/DQ2が付く場合がある）
      for (const [name, link] of charPages.entries()){
        if (!name) continue;
        if (name.includes(chara) || chara.includes(name)) { href = link; break; }
      }
    }
    if (!href){
      renderLuckBaseInfo();
      return;
    }

    const info = await withIframe(href, (doc) => extractLuckInfoFromCharacter(doc, lv));
    if (!info){
      renderLuckBaseInfo();
      return;
    }

    const luckInput = $("luck");
    if ((luckInput.value || "").trim() === "" && Number.isFinite(info.luck)){
      luckInput.value = String(Math.trunc(info.luck));
    }

    const game = $("game").value;
    const luck = safeNumber(luckInput.value, null);
    const low = info.low;
    const high = info.high;
    const autoBand = decideLuckBand(game, luck, low, high);

    lastLuckInfo = { low, high, luck, band: autoBand };

    renderLuckBaseInfo();

    // 自動を選んでいる場合は計算だけ自動バンドを使う（select自体は自動のまま）
    // なのでここでは select を書き換えない
  }

  function getEffectiveLuckBand(){
    const bandSel = $("luckBand").value;
    if (bandSel !== "auto") return bandSel;
    return lastLuckInfo?.band || "中"; // 情報が無い時は中
  }

  // ====== 計算 ======
  function compute(stageOverride=null){
    const game = $("game").value;
    const mode = $("mode").value;
    const A = safeNumber($("atk").value, null);
    const D = safeNumber($("def").value, null);
    if (A === null || D === null) return { error: "攻撃/防御" };

    const base = baseDamage(game, A, D);
    const modeMult = MODE_MULT[mode] ?? 1.0;

    const band = getEffectiveLuckBand();
    const luckMult = (LUCK_MULT[game]?.[band] ?? 1.0);

    const skillMult = safeNumber($("skillMult").value, 1.0) ?? 1.0;

    const bikilt = $("bikilt").checked ? 2.0 : 1.0;

    const tame = $("tame").value;
    const tameMult = (tame === "tame" || tame === "ouen") ? 2.0 : (tame === "super_tame") ? 3.0 : 1.0;

    const stage = stageOverride !== null ? stageOverride : safeNumber($("defStage").value, 0) ?? 0;
    const defMult = stageMult(stage);

    const totalMult = modeMult * luckMult * skillMult * bikilt * tameMult * defMult;

    const meanRaw = base * totalMult;
    const minRaw = meanRaw * RAND_MIN;
    const maxRaw = meanRaw * RAND_MAX;

    return {
      game, mode, A, D,
      enemy: $("enemy").value || "",
      skill: $("skill").value || "",
      band,
      stage,
      mult: totalMult,
      mean: floor0(meanRaw),
      min: floor0(minRaw),
      max: floor0(maxRaw),
    };
  }

  function setResultMain(text){
    $("resultMain").textContent = text;
  }

  function renderResult(){
    const unknown = $("stageUnknown").checked;

    if (!unknown){
      const r = compute();
      if (r.error){ setResultMain("-"); return; }
      setResultMain(`${r.mean}（${r.min}〜${r.max}）`);
      return;
    }

    // 段階不明：↓1/3/6 と ↑1/3/6 を同時表示
    const stages = [-1, -3, -6, 1, 3, 6];
    const parts = [];
    for (const s of stages){
      const r = compute(s);
      if (r.error) continue;
      const tag = s < 0 ? `↓${Math.abs(s)}` : `↑${s}`;
      parts.push(`${tag}:${r.mean}（${r.min}〜${r.max}）`);
    }
    setResultMain(parts.join(" / "));
  }

  // ====== ログ ======
  const logs = [];

  function renderLogs(){
    const tbody = $("logTable").querySelector("tbody");
    tbody.innerHTML = "";
    for (const row of logs){
      const tr = document.createElement("tr");
      const cells = [
        row.game, row.enemy, row.A, row.D, row.band, row.mode, row.skill,
        fmt(row.mult, 6), row.mean, row.min, row.max
      ];
      for (const c of cells){
        const td = document.createElement("td");
        td.textContent = String(c);
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
  }

  function addLog(){
    const unknown = $("stageUnknown").checked;
    const mode = $("mode").value;
    if (!unknown){
      const r = compute();
      if (r.error) return;
      logs.push(r);
      renderLogs();
      return;
    }
    const stages = [-1, -3, -6, 1, 3, 6];
    for (const s of stages){
      const r = compute(s);
      if (r.error) continue;
      logs.push(r);
    }
    renderLogs();
  }

  function downloadCsv(){
    const headers = ["作品","敵","攻撃","防御","運基準","モード","技","倍率合計","平均","最小","最大"];
    const rows = logs.map(r => [
      r.game, r.enemy, r.A, r.D, r.band, r.mode, r.skill,
      fmt(r.mult, 10), r.mean, r.min, r.max
    ]);
    const esc = (v) => {
      const s = String(v ?? "");
      if (/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
      return s;
    };
    const csv = [headers, ...rows].map(r => r.map(esc).join(",")).join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "damage_log.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  }

  // ====== Bind ======
  function bind(){
    $("btnCalc").addEventListener("click", () => { addLog(); renderResult(); });
    $("btnClear").addEventListener("click", () => { logs.length = 0; renderLogs(); renderResult(); });
    $("btnCsv").addEventListener("click", downloadCsv);

    $("setSkillNormal").addEventListener("click", () => {
      const sel = $("skill");
      const op = sel.options[sel.selectedIndex];
      const m = safeNumber(op?.dataset?.mult, 1.0) ?? 1.0;
      $("skillMult").value = String(m);
      renderResult();
    });
    $("setSkillEffective").addEventListener("click", () => {
      const sel = $("skill");
      const op = sel.options[sel.selectedIndex];
      const eff = safeNumber(op?.dataset?.multEff, null);
      const m = eff !== null ? eff : (safeNumber(op?.dataset?.mult, 1.0) ?? 1.0);
      $("skillMult").value = String(m);
      renderResult();
    });

    const ids = ["game","mode","enemy","atk","def","skill","skillMult","bikilt","tame","defStage","stageUnknown","chara","lv","luck","luckBand"];
    ids.forEach(id => {
      $(id).addEventListener("change", async () => {
        if (id === "enemy"){
          const sel = $("enemy");
          const op = sel.options[sel.selectedIndex];
          const d = safeNumber(op?.dataset?.def, null);
          if (d !== null) $("def").value = String(d);
        }
        if (id === "skill"){
          const sel = $("skill");
          const op = sel.options[sel.selectedIndex];
          const m = safeNumber(op?.dataset?.mult, null);
          if (m !== null) $("skillMult").value = String(m);
          else $("skillMult").value = "1";
          updateSkillButtons();
        }
        if (id === "game"){
          await bootGame($("game").value);
        }
        if (id === "chara" || id === "lv"){
          await updateLuckAuto();
        }
        if (id === "luck"){
          renderLuckBaseInfo();
          // 自動バンドの再判定
          if ($("luckBand").value === "auto"){
            // lastLuckInfo に luck を反映させて band 更新
            if (lastLuckInfo){
              const game = $("game").value;
              const luck = safeNumber($("luck").value, null);
              lastLuckInfo.luck = luck;
              lastLuckInfo.band = decideLuckBand(game, luck, lastLuckInfo.low, lastLuckInfo.high);
            }
          }
        }
        renderResult();
      });
      // inputでも即反映
      $(id).addEventListener("input", () => {
        if (id === "skillMult"){
          const v = safeNumber($("skillMult").value, null);
          if (v === null) $("skillMult").value = "1";
        }
        renderLuckBaseInfo();
        renderResult();
      });
    });

    // 初期値：倍率は1
    if (($("skillMult").value || "").trim() === "") $("skillMult").value = "1";
  }

  async function bootGame(game){
    try{
      await loadEnemies(game);
    }catch(e){}
    try{
      await loadSkills(game);
    }catch(e){}
    refreshEnemySelect();
    refreshSkillSelect();
    renderResult();
  }

  async function boot(){
    try{ await loadCharacterIndex(); }catch(e){}
    await bootGame($("game").value);
    await updateLuckAuto();
    bind();
    renderResult();
  }

  // ====== Start ======
  boot();
})();
</script>
</body>
</html>
