<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>DQ1・DQ2 アイテム所持金計算機</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #020617;
      color: #e5e7eb;
    }
    h1 {
      font-size: 1.4rem;
      margin: 0 0 8px;
    }
    p {
      margin: 4px 0 12px;
      font-size: 0.9rem;
      color: #9ca3af;
    }
    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 12px;
    }
    label {
      font-size: 0.9rem;
    }
    select, input[type="number"] {
      background-color: #020617;
      color: #e5e7eb;
      border: 1px solid #4b5563;
      border-radius: 4px;
      padding: 2px 6px;
      font-size: 0.9rem;
    }
    input[type="number"] {
      width: 80px;
    }
    button {
      font-size: 0.85rem;
      padding: 4px 10px;
      border-radius: 4px;
      border: 1px solid #4b5563;
      background-color: #111827;
      color: #e5e7eb;
      cursor: pointer;
    }
    button:hover {
      background-color: #1f2937;
    }
    .summary-box {
      margin-top: 16px;
      margin-bottom: 16px;
      border: 1px solid #374151;
      padding: 8px 10px;
      background: #020617;
    }
    .summary-box h2 {
      margin: 0 0 4px;
      font-size: 1rem;
    }
    .summary-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      font-size: 0.9rem;
    }
    .summary-row + .summary-row {
      margin-top: 2px;
    }
    .summary-label {
      color: #9ca3af;
    }
    .summary-value {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    .calc-grid {
      display: grid;
      gap: 16px;
    }
    @media (min-width: 900px) {
      .calc-grid {
        grid-template-columns: 1fr 1fr;
      }
    }
    .calc-section h2 {
      font-size: 1rem;
      margin: 0 0 6px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    th, td {
      border-bottom: 1px solid #1f2937;
      padding: 2px 4px;
    }
    th {
      text-align: left;
      color: #9ca3af;
      font-weight: 500;
    }
    td.nowrap {
      white-space: nowrap;
    }
    tfoot td {
      border-top: none;
      padding-top: 6px;
    }
    .note {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <h1>DQ1・DQ2 アイテム所持金計算機</h1>
  <p>所持金・買うもの・売るものを入力すると、買い物後の所持金と足りるかどうかを確認できます。</p>

  <div class="controls-row">
    <label>作品：
      <select id="game-select">
        <option value="dq1">DQ1</option>
        <option value="dq2">DQ2</option>
      </select>
    </label>
    <label>現在の所持金：
      <input type="number" id="current-gold" min="0" step="1" value="0" />
      G
    </label>
  </div>

  <div class="summary-box">
    <h2>計算結果</h2>
    <div class="summary-row">
      <div class="summary-label">現在の所持金</div>
      <div class="summary-value" id="summary-current">0 G</div>
    </div>
    <div class="summary-row">
      <div class="summary-label">売却合計</div>
      <div class="summary-value" id="summary-sell">0 G</div>
    </div>
    <div class="summary-row">
      <div class="summary-label">購入合計</div>
      <div class="summary-value" id="summary-buy">0 G</div>
    </div>
    <div class="summary-row">
      <div class="summary-label">買い物後の所持金</div>
      <div class="summary-value" id="summary-after">0 G</div>
    </div>
    <div class="summary-row">
      <div class="summary-label">判定</div>
      <div class="summary-value" id="summary-result">-</div>
    </div>
  </div>

  <div class="calc-grid">
    <section class="calc-section">
      <h2>買うアイテム</h2>
      <table>
        <thead>
          <tr>
            <th>アイテム</th>
            <th>個数</th>
            <th>単価</th>
            <th>小計</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="buy-rows">
        </tbody>
        <tfoot>
          <tr>
            <td colspan="5">
              <button type="button" id="add-buy-row">行を追加</button>
              <button type="button" id="clear-buy-rows">入力をクリア</button>
            </td>
          </tr>
        </tfoot>
      </table>
      <div class="note">※ 最大10行まで追加できます。</div>
    </section>

    <section class="calc-section">
      <h2>売るアイテム</h2>
      <table>
        <thead>
          <tr>
            <th>アイテム</th>
            <th>個数</th>
            <th>単価</th>
            <th>小計</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="sell-rows">
        </tbody>
        <tfoot>
          <tr>
            <td colspan="5">
              <button type="button" id="add-sell-row">行を追加</button>
              <button type="button" id="clear-sell-rows">入力をクリア</button>
            </td>
          </tr>
        </tfoot>
      </table>
      <div class="note">※ 最大10行まで追加できます。</div>
    </section>
  </div>

  <script>
    const MAX_ROWS = 10;
    const INITIAL_ROWS = 3;

    let currentGame = "dq1";
    let allItems = [];
    let buyableItems = [];
    let sellableItems = [];

    function parseCSV(text) {
      const lines = text.trim().split(/\r?\n/);
      if (lines.length <= 1) return { headers: [], rows: [] };
      const headers = lines[0].split(",");
      const rows = lines.slice(1)
        .map(line => line.trim())
        .filter(line => line.length > 0)
        .map(line => line.split(","));
      return { headers, rows };
    }

    async function loadItems(game) {
      const path = game === "dq1" ? "data/dq1_items.csv" : "data/dq2_items.csv";
      try {
        const res = await fetch(path);
        const text = await res.text();
        const { headers, rows } = parseCSV(text);
        const idxName = headers.indexOf("名前");
        const idxBuy = headers.indexOf("買値");
        const idxSell = headers.indexOf("売値");

        allItems = [];
        buyableItems = [];
        sellableItems = [];

        if (idxName === -1 || idxBuy === -1 || idxSell === -1) {
          populateItemSelects();
          recalcAll();
          return;
        }

        for (const cols of rows) {
          const name = cols[idxName] || "";
          if (!name) continue;
          const buy = Number(cols[idxBuy] || "0") || 0;
          const sell = Number(cols[idxSell] || "0") || 0;
          const item = { name, buy, sell };
          allItems.push(item);
        }

        buyableItems = allItems.filter(i => i.buy > 0);
        sellableItems = allItems.filter(i => i.sell > 0);

        populateItemSelects();
        recalcAll();
      } catch (e) {
        console.error("アイテム読み込みエラー:", e);
        allItems = [];
        buyableItems = [];
        sellableItems = [];
        populateItemSelects();
        recalcAll();
      }
    }

    function populateItemSelects() {
      const buySelects = document.querySelectorAll(".buy-name");
      const sellSelects = document.querySelectorAll(".sell-name");

      buySelects.forEach(sel => {
        const current = sel.value;
        sel.innerHTML = "";
        const emptyOpt = document.createElement("option");
        emptyOpt.value = "";
        emptyOpt.textContent = "";
        sel.appendChild(emptyOpt);
        for (const item of buyableItems) {
          const opt = document.createElement("option");
          opt.value = item.name;
          opt.textContent = item.name;
          sel.appendChild(opt);
        }
        if (current) {
          sel.value = current;
        }
      });

      sellSelects.forEach(sel => {
        const current = sel.value;
        sel.innerHTML = "";
        const emptyOpt = document.createElement("option");
        emptyOpt.value = "";
        emptyOpt.textContent = "";
        sel.appendChild(emptyOpt);
        for (const item of sellableItems) {
          const opt = document.createElement("option");
          opt.value = item.name;
          opt.textContent = item.name;
          sel.appendChild(opt);
        }
        if (current) {
          sel.value = current;
        }
      });
    }

    function addBuyRow() {
      const body = document.getElementById("buy-rows");
      if (body.querySelectorAll("tr").length >= MAX_ROWS) return;

      const tr = document.createElement("tr");

      const tdName = document.createElement("td");
      const selectName = document.createElement("select");
      selectName.className = "buy-name";
      selectName.addEventListener("change", recalcAll);
      tdName.appendChild(selectName);
      tr.appendChild(tdName);

      const tdQty = document.createElement("td");
      const inputQty = document.createElement("input");
      inputQty.type = "number";
      inputQty.min = "0";
      inputQty.step = "1";
      inputQty.className = "buy-qty";
      inputQty.addEventListener("input", recalcAll);
      tdQty.appendChild(inputQty);
      tr.appendChild(tdQty);

      const tdUnit = document.createElement("td");
      tdUnit.className = "buy-unit nowrap";
      tr.appendChild(tdUnit);

      const tdSub = document.createElement("td");
      tdSub.className = "buy-subtotal nowrap";
      tr.appendChild(tdSub);

      const tdOp = document.createElement("td");
      const btnClear = document.createElement("button");
      btnClear.type = "button";
      btnClear.textContent = "行クリア";
      btnClear.addEventListener("click", () => {
        const sel = tr.querySelector(".buy-name");
        const qty = tr.querySelector(".buy-qty");
        const unit = tr.querySelector(".buy-unit");
        const sub = tr.querySelector(".buy-subtotal");
        if (sel) sel.value = "";
        if (qty) qty.value = "";
        if (unit) unit.textContent = "";
        if (sub) sub.textContent = "";
        recalcAll();
      });
      tdOp.appendChild(btnClear);
      tr.appendChild(tdOp);

      body.appendChild(tr);
    }

    function addSellRow() {
      const body = document.getElementById("sell-rows");
      if (body.querySelectorAll("tr").length >= MAX_ROWS) return;

      const tr = document.createElement("tr");

      const tdName = document.createElement("td");
      const selectName = document.createElement("select");
      selectName.className = "sell-name";
      selectName.addEventListener("change", recalcAll);
      tdName.appendChild(selectName);
      tr.appendChild(tdName);

      const tdQty = document.createElement("td");
      const inputQty = document.createElement("input");
      inputQty.type = "number";
      inputQty.min = "0";
      inputQty.step = "1";
      inputQty.className = "sell-qty";
      inputQty.addEventListener("input", recalcAll);
      tdQty.appendChild(inputQty);
      tr.appendChild(tdQty);

      const tdUnit = document.createElement("td");
      tdUnit.className = "sell-unit nowrap";
      tr.appendChild(tdUnit);

      const tdSub = document.createElement("td");
      tdSub.className = "sell-subtotal nowrap";
      tr.appendChild(tdSub);

      const tdOp = document.createElement("td");
      const btnClear = document.createElement("button");
      btnClear.type = "button";
      btnClear.textContent = "行クリア";
      btnClear.addEventListener("click", () => {
        const sel = tr.querySelector(".sell-name");
        const qty = tr.querySelector(".sell-qty");
        const unit = tr.querySelector(".sell-unit");
        const sub = tr.querySelector(".sell-subtotal");
        if (sel) sel.value = "";
        if (qty) qty.value = "";
        if (unit) unit.textContent = "";
        if (sub) sub.textContent = "";
        recalcAll();
      });
      tdOp.appendChild(btnClear);
      tr.appendChild(tdOp);

      body.appendChild(tr);
    }

    function clearBuyRows() {
      const body = document.getElementById("buy-rows");
      const rows = body.querySelectorAll("tr");
      rows.forEach(tr => {
        const sel = tr.querySelector(".buy-name");
        const qty = tr.querySelector(".buy-qty");
        const unit = tr.querySelector(".buy-unit");
        const sub = tr.querySelector(".buy-subtotal");
        if (sel) sel.value = "";
        if (qty) qty.value = "";
        if (unit) unit.textContent = "";
        if (sub) sub.textContent = "";
      });
      recalcAll();
    }

    function clearSellRows() {
      const body = document.getElementById("sell-rows");
      const rows = body.querySelectorAll("tr");
      rows.forEach(tr => {
        const sel = tr.querySelector(".sell-name");
        const qty = tr.querySelector(".sell-qty");
        const unit = tr.querySelector(".sell-unit");
        const sub = tr.querySelector(".sell-subtotal");
        if (sel) sel.value = "";
        if (qty) qty.value = "";
        if (unit) unit.textContent = "";
        if (sub) sub.textContent = "";
      });
      recalcAll();
    }

    function setupRows() {
      const buyBody = document.getElementById("buy-rows");
      const sellBody = document.getElementById("sell-rows");
      buyBody.innerHTML = "";
      sellBody.innerHTML = "";

      for (let i = 0; i < INITIAL_ROWS; i++) {
        addBuyRow();
        addSellRow();
      }

      const addBuyBtn = document.getElementById("add-buy-row");
      const addSellBtn = document.getElementById("add-sell-row");
      const clearBuyBtn = document.getElementById("clear-buy-rows");
      const clearSellBtn = document.getElementById("clear-sell-rows");

      if (addBuyBtn) {
        addBuyBtn.onclick = () => {
          addBuyRow();
          populateItemSelects();
          recalcAll();
        };
      }
      if (addSellBtn) {
        addSellBtn.onclick = () => {
          addSellRow();
          populateItemSelects();
          recalcAll();
        };
      }
      if (clearBuyBtn) {
        clearBuyBtn.onclick = () => clearBuyRows();
      }
      if (clearSellBtn) {
        clearSellBtn.onclick = () => clearSellRows();
      }
    }

    function findItemByName(name, forBuy) {
      if (!name) return null;
      const list = forBuy ? buyableItems : sellableItems;
      return list.find(i => i.name === name) || null;
    }

    function formatGold(n) {
      const value = Number.isFinite(n) ? n : 0;
      return value.toLocaleString("ja-JP") + " G";
    }

    function recalcAll() {
      const currentGoldInput = document.getElementById("current-gold");
      const currentGold = Number(currentGoldInput.value || "0") || 0;

      let buyTotal = 0;
      let sellTotal = 0;

      // 買う側
      const buyRows = document.querySelectorAll("#buy-rows tr");
      buyRows.forEach(tr => {
        const sel = tr.querySelector(".buy-name");
        const qtyInput = tr.querySelector(".buy-qty");
        const unitCell = tr.querySelector(".buy-unit");
        const subCell = tr.querySelector(".buy-subtotal");

        const name = sel ? sel.value : "";
        const qty = Number(qtyInput && qtyInput.value ? qtyInput.value : "0") || 0;
        const item = findItemByName(name, true);
        const unit = item ? item.buy : 0;
        const sub = unit * qty;

        if (unitCell) unitCell.textContent = unit ? formatGold(unit).replace(" G", "") + " G" : "";
        if (subCell) subCell.textContent = sub ? formatGold(sub) : "";

        buyTotal += sub;
      });

      // 売る側
      const sellRows = document.querySelectorAll("#sell-rows tr");
      sellRows.forEach(tr => {
        const sel = tr.querySelector(".sell-name");
        const qtyInput = tr.querySelector(".sell-qty");
        const unitCell = tr.querySelector(".sell-unit");
        const subCell = tr.querySelector(".sell-subtotal");

        const name = sel ? sel.value : "";
        const qty = Number(qtyInput && qtyInput.value ? qtyInput.value : "0") || 0;
        const item = findItemByName(name, false);
        const unit = item ? item.sell : 0;
        const sub = unit * qty;

        if (unitCell) unitCell.textContent = unit ? formatGold(unit).replace(" G", "") + " G" : "";
        if (subCell) subCell.textContent = sub ? formatGold(sub) : "";

        sellTotal += sub;
      });

      const usable = currentGold + sellTotal;
      const after = usable - buyTotal;

      document.getElementById("summary-current").textContent = formatGold(currentGold);
      document.getElementById("summary-sell").textContent = formatGold(sellTotal);
      document.getElementById("summary-buy").textContent = formatGold(buyTotal);
      document.getElementById("summary-after").textContent = formatGold(after);

      let resultText = "-";
      if (buyTotal === 0) {
        if (sellTotal === 0) {
          resultText = "買い物なし";
        } else {
          resultText = "売却のみ（買い物なし）";
        }
      } else {
        if (usable >= buyTotal) {
          resultText = "購入可能";
        } else {
          const lack = buyTotal - usable;
          resultText = "あと " + lack.toLocaleString("ja-JP") + " G 足りません";
        }
      }
      document.getElementById("summary-result").textContent = resultText;
    }

    document.addEventListener("DOMContentLoaded", () => {
      const gameSelect = document.getElementById("game-select");
      const currentGoldInput = document.getElementById("current-gold");

      gameSelect.addEventListener("change", () => {
        currentGame = gameSelect.value;
        loadItems(currentGame);
      });

      currentGoldInput.addEventListener("input", recalcAll);

      setupRows();
      loadItems(currentGame);
    });
  </script>
</body>
</html>
